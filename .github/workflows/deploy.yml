name: Deploy PebbleDrive

on:
  push:
    branches: [ main ]  # åªæœ‰ main åˆ†æ”¯éƒ¨ç½² workers
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend (Workers)

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci

    - name: Verify and Configure Backend
      run: |
        cd backend
        echo "ğŸ” éªŒè¯åç«¯é…ç½®..."

        # 1. å¤åˆ¶ç¤ºä¾‹é…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f wrangler.toml ]; then
          echo "ğŸ“‹ ä»ç¤ºä¾‹é…ç½®åˆ›å»º wrangler.toml..."
          cp wrangler.toml.example wrangler.toml
        fi

        # 2. è·å–æˆ–åˆ›å»º D1 æ•°æ®åº“
        echo "ğŸ—„ï¸ æ£€æŸ¥ D1 æ•°æ®åº“..."
        DB_ID=$(npx wrangler d1 list | grep pebble-drive-db | awk '{print $2}' || echo "")

        if [ -z "$DB_ID" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°æ•°æ®åº“ pebble-drive-dbï¼Œæ­£åœ¨åˆ›å»º..."
          DB_ID=$(npx wrangler d1 create pebble-drive-db --json | jq -r '.database_id')
          echo "âœ… æ•°æ®åº“åˆ›å»ºæˆåŠŸ: $DB_ID"
        else
          echo "âœ… æ‰¾åˆ°æ•°æ®åº“ ID: $DB_ID"
        fi

        # æ›´æ–° wrangler.toml ä¸­çš„ database_id
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i '' "s/database_id = \".*\"/database_id = \"$DB_ID\"/" wrangler.toml
        else
          sed -i "s/database_id = \".*\"/database_id = \"$DB_ID\"/" wrangler.toml
        fi

        # 3. è·å–æˆ–åˆ›å»º KV Namespaceï¼ˆç”¨äºé€Ÿç‡é™åˆ¶ï¼‰
        echo "ğŸ”‘ æ£€æŸ¥ KV Namespace..."
        KV_ID=$(npx wrangler kv namespace list | grep -E '"title":\s*"RATE_LIMIT"' | grep -v preview | jq -r '.id' || echo "")
        KV_PREVIEW_ID=$(npx wrangler kv namespace list | grep -E '"title":\s*"RATE_LIMIT_preview"' | jq -r '.id' || echo "")

        if [ -z "$KV_ID" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ° RATE_LIMIT KVï¼Œæ­£åœ¨åˆ›å»º..."
          KV_ID=$(npx wrangler kv namespace create RATE_LIMIT --json | jq -r '.id')
          echo "âœ… KV Namespace åˆ›å»ºæˆåŠŸ: $KV_ID"
        else
          echo "âœ… æ‰¾åˆ° KV ID: $KV_ID"
        fi

        if [ -z "$KV_PREVIEW_ID" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ° RATE_LIMIT_preview KVï¼Œæ­£åœ¨åˆ›å»º..."
          KV_PREVIEW_ID=$(npx wrangler kv namespace create RATE_LIMIT --preview --json | jq -r '.id')
          echo "âœ… KV Preview Namespace åˆ›å»ºæˆåŠŸ: $KV_PREVIEW_ID"
        else
          echo "âœ… æ‰¾åˆ° KV Preview ID: $KV_PREVIEW_ID"
        fi

        # æ›´æ–° wrangler.toml ä¸­çš„ KV IDs
        if [[ "$OSTYPE" == "darwin"* ]]; then
          # macOS sed è¯­æ³•
          sed -i '' "/binding = \"RATE_LIMIT_KV\"/,/preview_id/ {
            s/id = \".*\"/id = \"$KV_ID\"/
            s/preview_id = \".*\"/preview_id = \"$KV_PREVIEW_ID\"/
          }" wrangler.toml
        else
          # Linux sed è¯­æ³•
          sed -i "/binding = \"RATE_LIMIT_KV\"/,/preview_id/ {
            s/id = \".*\"/id = \"$KV_ID\"/
            s/preview_id = \".*\"/preview_id = \"$KV_PREVIEW_ID\"/
          }" wrangler.toml
        fi

        echo "âœ… åç«¯é…ç½®éªŒè¯å®Œæˆ"
        cat wrangler.toml
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Deploy Backend to Cloudflare Workers
      run: |
        cd backend
        echo "ğŸš€ éƒ¨ç½²åç«¯åˆ° Cloudflare Workers..."
        npx wrangler deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Initialize Database Schema
      run: |
        cd backend
        echo "ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„..."
        npx wrangler d1 execute pebble-drive-db --file=./migrations/schema.sql || echo "âš ï¸ æ•°æ®åº“è¡¨å·²å­˜åœ¨æˆ–åˆå§‹åŒ–å¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Backend Deployment Success
      run: |
        echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ Worker å·²éƒ¨ç½²ï¼ŒURL å°†åœ¨ä¸‹ä¸€æ­¥è·å–"

  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend (Pages)
    needs: deploy-backend

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci

    - name: Get Worker URL
      id: worker-url
      run: |
        cd backend
        # ä» wrangler.toml è·å– worker åç§°
        WORKER_NAME=$(grep '^name = ' wrangler.toml | sed 's/name = "\(.*\)"/\1/')

        # è·å– Cloudflare è´¦æˆ·çš„å­åŸŸå
        SUBDOMAIN=$(npx wrangler whoami 2>/dev/null | grep 'subdomain' | awk '{print $2}' || echo "")

        if [ -n "$SUBDOMAIN" ]; then
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
        else
          # å›é€€ï¼šä½¿ç”¨é»˜è®¤æ ¼å¼
          WORKER_URL="https://${WORKER_NAME}.workers.dev"
        fi

        echo "worker_url=${WORKER_URL}" >> $GITHUB_OUTPUT
        echo "âœ… Worker URL: ${WORKER_URL}"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Build Frontend
      run: |
        cd frontend
        echo "ğŸ—ï¸ æ„å»ºå‰ç«¯..."
        echo "ğŸ“¡ API åœ°å€: ${{ steps.worker-url.outputs.worker_url }}"
        echo "ğŸ” Turnstile Site Key: ${TURNSTILE_SITE_KEY:0:10}..."
        npm run build
      env:
        VITE_API_BASE_URL: ${{ steps.worker-url.outputs.worker_url }}
        VITE_TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY }}

    - name: Verify Build Output
      run: |
        cd frontend
        echo "ğŸ” éªŒè¯æ„å»ºè¾“å‡º..."

        # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®æ³¨å…¥
        if grep -q "ENV_API_BASE_URL = '${{ steps.worker-url.outputs.worker_url }}'" dist/index.html; then
          echo "âœ… API_BASE_URL æ³¨å…¥æˆåŠŸ"
        else
          echo "âŒ API_BASE_URL æ³¨å…¥å¤±è´¥"
          exit 1
        fi

        if grep -q "VITE_TURNSTILE_SITE_KEY = '${{ secrets.TURNSTILE_SITE_KEY }}'" dist/index.html; then
          echo "âœ… TURNSTILE_SITE_KEY æ³¨å…¥æˆåŠŸ"
        else
          echo "âš ï¸ TURNSTILE_SITE_KEY æ³¨å…¥å¤±è´¥ï¼ˆå¯èƒ½æœªé…ç½®ï¼‰"
        fi

    - name: Deploy Frontend to Cloudflare Pages
      run: |
        cd frontend
        echo "ğŸš€ éƒ¨ç½²å‰ç«¯åˆ° Cloudflare Pages..."
        # ä»ç¯å¢ƒå˜é‡è·å–é¡¹ç›®åï¼Œé»˜è®¤ä¸º pebble-drive
        PROJECT_NAME="${PAGES_PROJECT_NAME:-pebble-drive}"
        npx wrangler pages deploy dist --project-name=$PROJECT_NAME
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        PAGES_PROJECT_NAME: ${{ secrets.PAGES_PROJECT_NAME }}

    - name: Deployment Complete
      run: |
        echo "ğŸ‰ PebbleDrive å®Œæ•´éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "   ğŸ”§ åç«¯ API: ${{ steps.worker-url.outputs.worker_url }}"
        echo "   ğŸ¨ å‰ç«¯åº”ç”¨: æŸ¥çœ‹ä¸Šæ–¹ Pages éƒ¨ç½²è¾“å‡ºè·å– URL"
        echo ""
        echo "âš ï¸  é‡è¦æé†’ï¼šé¦–æ¬¡éƒ¨ç½²åéœ€è¦é…ç½® Worker Secrets"
        echo ""
        echo "ğŸ“Œ å¿…éœ€çš„ Worker Secretsï¼ˆåç«¯å¯†é’¥ï¼‰ï¼š"
        echo "   1. AUTH_PASSWORD          - ç™»å½•å¯†ç ï¼ˆå¿…éœ€ï¼‰"
        echo "   2. AUTH_TOKEN_SECRET      - JWT å¯†é’¥ï¼Œ32ä½éšæœºå­—ç¬¦ä¸²ï¼ˆå¿…éœ€ï¼‰"
        echo "   3. TURNSTILE_SECRET_KEY   - Turnstile éªŒè¯å¯†é’¥ï¼ˆå¿…éœ€ï¼‰"
        echo ""
        echo "ğŸ”§ é…ç½®å‘½ä»¤ï¼ˆåœ¨æœ¬åœ°è¿è¡Œï¼‰ï¼š"
        echo "   cd backend"
        echo "   echo 'your-password' | npx wrangler secret put AUTH_PASSWORD"
        echo "   openssl rand -base64 32 | npx wrangler secret put AUTH_TOKEN_SECRET"
        echo "   echo 'your-turnstile-secret' | npx wrangler secret put TURNSTILE_SECRET_KEY"
        echo ""
        echo "ğŸ“Œ å¿…éœ€çš„ GitHub Secretsï¼ˆå‰ç«¯æ„å»ºï¼‰ï¼š"
        echo "   CLOUDFLARE_API_TOKEN      - å·²é…ç½® âœ…"
        echo "   CLOUDFLARE_ACCOUNT_ID     - å·²é…ç½® âœ…"
        echo "   TURNSTILE_SITE_KEY        - Turnstile ç«™ç‚¹å¯†é’¥"
        echo "   PAGES_PROJECT_NAME        - Pages é¡¹ç›®åï¼ˆå¯é€‰ï¼Œé»˜è®¤ pebble-driveï¼‰"
        echo ""
        echo "ğŸ”‘ è·å– Turnstile å¯†é’¥ï¼š"
        echo "   è®¿é—® https://dash.cloudflare.com/?to=/:account/turnstile"
        echo "   åˆ›å»ºç«™ç‚¹åè·å– Site Key å’Œ Secret Key"
        echo ""
        echo "ğŸ“ æ›´å¤šé…ç½®è¯´æ˜ï¼š"
        echo "   - æŸ¥çœ‹ backend/wrangler.toml è°ƒæ•´æ–‡ä»¶å¤§å°é™åˆ¶ã€é€Ÿç‡é™åˆ¶ç­‰"
        echo "   - æ‰€æœ‰ç¯å¢ƒå˜é‡éƒ½åœ¨ wrangler.toml [vars] éƒ¨åˆ†"
