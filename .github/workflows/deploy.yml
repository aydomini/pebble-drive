name: Deploy PebbleDrive

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    name: Deploy Backend (Workers)

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci

    - name: Verify Backend Configuration
      run: |
        cd backend
        echo "ğŸ” éªŒè¯åç«¯é…ç½®..."

        # Copy example config if wrangler.toml doesn't exist
        if [ ! -f wrangler.toml ]; then
          echo "ğŸ“‹ ä»ç¤ºä¾‹é…ç½®åˆ›å»º wrangler.toml..."
          cp wrangler.toml.example wrangler.toml
        fi

        # Get database ID dynamically from Cloudflare
        echo "ğŸ” è·å–æ•°æ®åº“ ID..."
        DB_ID=$(npx wrangler d1 list | grep pebble-drive-db | awk '{print $2}' || echo "")

        if [ -z "$DB_ID" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°æ•°æ®åº“ï¼Œå°†åœ¨éƒ¨ç½²æ—¶åˆ›å»º"
        else
          echo "âœ… æ‰¾åˆ°æ•°æ®åº“ ID: $DB_ID"
          # Update wrangler.toml with real database_id (works on both Linux and macOS)
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/database_id = \"your-database-id\"/database_id = \"$DB_ID\"/" wrangler.toml
          else
            sed -i "s/database_id = \"your-database-id\"/database_id = \"$DB_ID\"/" wrangler.toml
          fi
        fi

        echo "âœ… åç«¯é…ç½®éªŒè¯é€šè¿‡"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Deploy Backend to Cloudflare Workers
      run: |
        cd backend
        echo "ğŸš€ éƒ¨ç½²åç«¯åˆ° Cloudflare Workers..."
        npx wrangler deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Initialize Database
      run: |
        cd backend
        echo "ğŸ—ƒï¸ åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„..."
        npx wrangler d1 execute pebble-drive-db --file=./migrations/schema.sql || echo "æ•°æ®åº“è¡¨å·²å­˜åœ¨æˆ–åˆå§‹åŒ–å¤±è´¥ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Backend Deployment Success
      run: |
        echo "âœ… åç«¯éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ Worker å·²éƒ¨ç½²ï¼ŒURL å°†åœ¨ä¸‹ä¸€æ­¥è·å–"

  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend (Pages)
    needs: deploy-backend

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci

    - name: Get Worker URL
      id: worker-url
      run: |
        cd backend
        # ä» wrangler.toml è·å– worker åç§°
        WORKER_NAME=$(grep '^name = ' wrangler.toml | sed 's/name = "\(.*\)"/\1/')
        # è·å– Cloudflare è´¦æˆ·çš„å­åŸŸå
        SUBDOMAIN=$(npx wrangler whoami 2>/dev/null | grep 'subdomain' | awk '{print $2}' || echo "")

        if [ -n "$SUBDOMAIN" ]; then
          WORKER_URL="https://${WORKER_NAME}.${SUBDOMAIN}.workers.dev"
        else
          # å›é€€ï¼šä½¿ç”¨é»˜è®¤æ ¼å¼
          WORKER_URL="https://${WORKER_NAME}.workers.dev"
        fi

        echo "worker_url=${WORKER_URL}" >> $GITHUB_OUTPUT
        echo "âœ… Worker URL: ${WORKER_URL}"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Build Frontend
      run: |
        cd frontend
        echo "ğŸ—ï¸ æ„å»ºå‰ç«¯..."
        echo "ğŸ“¡ API åœ°å€: ${{ steps.worker-url.outputs.worker_url }}"
        echo "ğŸ” Turnstile Site Key: ${TURNSTILE_SITE_KEY:0:10}..."
        npm run build
      env:
        VITE_API_BASE_URL: ${{ steps.worker-url.outputs.worker_url }}
        VITE_TURNSTILE_SITE_KEY: ${{ secrets.TURNSTILE_SITE_KEY }}

    - name: Deploy Frontend to Cloudflare Pages
      run: |
        cd frontend
        echo "ğŸš€ éƒ¨ç½²å‰ç«¯åˆ° Cloudflare Pages..."
        # ä»ç¯å¢ƒå˜é‡è·å–é¡¹ç›®åï¼Œé»˜è®¤ä¸º pebble-drive
        PROJECT_NAME="${PAGES_PROJECT_NAME:-pebble-drive}"
        npx wrangler pages deploy dist --project-name=$PROJECT_NAME
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        PAGES_PROJECT_NAME: ${{ secrets.PAGES_PROJECT_NAME }}

    - name: Deployment Complete
      run: |
        echo "ğŸ‰ PebbleDrive å®Œæ•´éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š"
        echo "   ğŸ”§ åç«¯ API: ${{ steps.worker-url.outputs.worker_url }}"
        echo "   ğŸ¨ å‰ç«¯åº”ç”¨: æŸ¥çœ‹ä¸Šæ–¹ Pages éƒ¨ç½²è¾“å‡ºè·å– URL"
        echo ""
        echo "âš ï¸  é‡è¦ï¼šé¦–æ¬¡éƒ¨ç½²åï¼Œè¯·è®¾ç½®ä»¥ä¸‹ Secretsï¼š"
        echo ""
        echo "   1. Worker Secretsï¼ˆåç«¯å¯†é’¥ï¼‰ï¼š"
        echo "      wrangler secret put AUTH_PASSWORD"
        echo "      wrangler secret put AUTH_TOKEN_SECRET"
        echo "      wrangler secret put TURNSTILE_SECRET_KEY"
        echo "      wrangler secret put STORAGE_QUOTA_GB"
        echo ""
        echo "   2. GitHub Secretsï¼ˆå‰ç«¯æ„å»ºï¼‰ï¼š"
        echo "      TURNSTILE_SITE_KEY - Turnstile ç«™ç‚¹å¯†é’¥"
        echo "      ï¼ˆåœ¨ä»“åº“ Settings â†’ Secrets â†’ Actions ä¸­æ·»åŠ ï¼‰"
        echo ""
        echo "   3. è·å– Turnstile å¯†é’¥ï¼š"
        echo "      è®¿é—® https://dash.cloudflare.com/?to=/:account/turnstile"
        echo "      åˆ›å»ºç«™ç‚¹åè·å– Site Key å’Œ Secret Key"
