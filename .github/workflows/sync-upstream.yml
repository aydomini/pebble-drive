name: Sync Upstream (åŒæ­¥ä¸Šæ¸¸ä»“åº“)

# ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è§¦å‘åŒæ­¥ï¼Œæˆ–è®¾ç½®å®šæ—¶åŒæ­¥
on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # å¯é€‰ï¼šæ¯å‘¨è‡ªåŠ¨åŒæ­¥ï¼ˆå–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨ï¼‰
  # schedule:
  #   - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥ 00:00 UTC

jobs:
  sync:
    runs-on: ubuntu-latest
    name: åŒæ­¥ä¸Šæ¸¸ä»“åº“æ›´æ–°

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: é…ç½® Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
      run: |
        # æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ ä¸Šæ¸¸ä»“åº“
        if ! git remote | grep -q upstream; then
          # å°è¯•ä» GitHub API è‡ªåŠ¨è·å–çˆ¶ä»“åº“ï¼ˆFork çš„æºä»“åº“ï¼‰
          REPO="${{ github.repository }}"
          PARENT_REPO=$(gh api repos/$REPO --jq '.parent.full_name' 2>/dev/null || echo "")

          if [ -n "$PARENT_REPO" ]; then
            git remote add upstream https://github.com/$PARENT_REPO.git
            echo "âœ… è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ ä¸Šæ¸¸ä»“åº“: $PARENT_REPO"
          else
            echo "::error::âŒ æ— æ³•è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸ä»“åº“"
            echo "::error::è¿™å¯èƒ½ä¸æ˜¯ä¸€ä¸ª Fork çš„ä»“åº“ï¼Œæˆ–è€…æ— æ³•è®¿é—®çˆ¶ä»“åº“ä¿¡æ¯"
            echo "::error::è¯·æ‰‹åŠ¨ç¼–è¾‘ .github/workflows/sync-upstream.yml ç¬¬ 34 è¡Œï¼Œæ·»åŠ ä¸Šæ¸¸ä»“åº“åœ°å€"
            echo "::error::ä¾‹å¦‚: git remote add upstream https://github.com/original-owner/PebbleDrive.git"
            exit 1
          fi
        else
          echo "â„¹ï¸  ä¸Šæ¸¸ä»“åº“å·²å­˜åœ¨"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è·å–ä¸Šæ¸¸æ›´æ–°
      run: |
        echo "ğŸ“¥ æ­£åœ¨è·å–ä¸Šæ¸¸ä»“åº“æ›´æ–°..."
        git fetch upstream

    - name: æ£€æŸ¥å†²çªå¹¶åˆå¹¶
      id: merge
      run: |
        # è·å–å½“å‰åˆ†æ”¯
        CURRENT_BRANCH=$(git branch --show-current)
        echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"

        # å°è¯•åˆå¹¶ä¸Šæ¸¸çš„ main åˆ†æ”¯
        echo "ğŸ”„ æ­£åœ¨åˆå¹¶ä¸Šæ¸¸ main åˆ†æ”¯..."

        if git merge upstream/main --no-edit; then
          echo "âœ… åˆå¹¶æˆåŠŸï¼"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "âš ï¸  æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼"
            echo "å†²çªæ–‡ä»¶ï¼š"
            git diff --name-only --diff-filter=U

            # å–æ¶ˆåˆå¹¶
            git merge --abort

            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT

            echo "::warning::åˆå¹¶å¤±è´¥ï¼šæ£€æµ‹åˆ°å†²çªï¼Œè¯·æ‰‹åŠ¨è§£å†³ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
            echo "::warning::git fetch upstream"
            echo "::warning::git merge upstream/main"
          else
            echo "â„¹ï¸  å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        fi

    - name: æ¨é€æ›´æ–°
      if: steps.merge.outputs.has_changes == 'true'
      run: |
        echo "ğŸ“¤ æ­£åœ¨æ¨é€æ›´æ–°åˆ° Fork ä»“åº“..."
        git push origin $(git branch --show-current)
        echo "âœ… åŒæ­¥å®Œæˆï¼"

    - name: å†²çªå¤„ç†æç¤º
      if: steps.merge.outputs.has_conflicts == 'true'
      run: |
        echo "::error::âŒ è‡ªåŠ¨åŒæ­¥å¤±è´¥ï¼šæ£€æµ‹åˆ°å†²çª"
        echo ""
        echo "ğŸ“ æ‰‹åŠ¨è§£å†³æ­¥éª¤ï¼š"
        echo "1. å…‹éš†ä½ çš„ Fork ä»“åº“"
        echo "2. æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼š"
        echo "   git remote add upstream https://github.com/ORIGINAL-OWNER/PebbleDrive.git"
        echo "3. è·å–ä¸Šæ¸¸æ›´æ–°ï¼š"
        echo "   git fetch upstream"
        echo "4. åˆå¹¶å¹¶è§£å†³å†²çªï¼š"
        echo "   git merge upstream/main"
        echo "5. è§£å†³å†²çªåæ¨é€ï¼š"
        echo "   git push origin main"
        exit 1

    - name: åŒæ­¥å®Œæˆé€šçŸ¥
      if: steps.merge.outputs.has_changes == 'true'
      run: |
        echo "ğŸ‰ åŒæ­¥æˆåŠŸï¼"
        echo ""
        echo "ğŸ“‹ æ›´æ–°æ—¥å¿—ï¼š"
        git log --oneline HEAD~5..HEAD
